!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.PSOPayment=t():e.PSOPayment=t()}(this,function(){return function(){"use strict";var e={d:function(t,o){for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}},t={};e.d(t,{default:function(){return i}});class o{constructor(e){this.config=e,this.overlay=null,this.popup=null,this.iframe=null,this.popupWindow=null,this.isOpen=!1,this.messageListener=null,this.intervalCheck=null}show(e){if(this.isOpen)return;this.options=e;const t=this.config.usePopupWindow||!1;t?this.openPopupWindow():(this.createOverlay(),this.createIframePopup(),this.attachEventListeners()),this.isOpen=!0,this.setupMessageListener(),t||(document.body.style.overflow="hidden",setTimeout(()=>{this.overlay.classList.add("pso-active"),this.popup.classList.add("pso-active")},10))}close(){this.isOpen&&(this.messageListener&&(window.removeEventListener("message",this.messageListener),this.messageListener=null),this.intervalCheck&&(clearInterval(this.intervalCheck),this.intervalCheck=null),this.popupWindow&&!this.popupWindow.closed&&(this.popupWindow.close(),this.popupWindow=null),this.overlay?(this.overlay.classList.remove("pso-active"),this.popup&&this.popup.classList.remove("pso-active"),setTimeout(()=>{this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.popup=null,this.iframe=null,this.isOpen=!1,document.body.style.overflow=""},300)):this.isOpen=!1)}openPopupWindow(){const e=`width=600,height=700,left=${(window.screen.width-600)/2},top=${(window.screen.height-700)/2},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`;if(this.popupWindow=window.open(this.options.gatewayUrl,"PSOPaymentGateway",e),!this.popupWindow)return this.createOverlay(),this.createIframePopup(),this.attachEventListeners(),document.body.style.overflow="hidden",void setTimeout(()=>{this.overlay.classList.add("pso-active"),this.popup.classList.add("pso-active")},10);this.intervalCheck=setInterval(()=>{this.popupWindow&&this.popupWindow.closed&&(clearInterval(this.intervalCheck),this.intervalCheck=null,this.handleCancel())},500),this.popupWindow.focus&&this.popupWindow.focus()}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="pso-overlay",document.body.appendChild(this.overlay)}createIframePopup(){this.popup=document.createElement("div"),this.popup.className="pso-popup pso-popup-iframe",this.popup.innerHTML=this.getIframePopupHTML(),this.overlay.appendChild(this.popup),this.iframe=this.popup.querySelector("#pso-gateway-iframe")}getIframePopupHTML(){return`\n      <div class="pso-header">\n        <h2>Secure Payment</h2>\n        <button class="pso-close" type="button">&times;</button>\n      </div>\n      <div class="pso-body pso-iframe-container">\n        <div class="pso-loading" id="pso-loading">\n          <div class="pso-spinner"></div>\n          <p>Loading payment gateway...</p>\n        </div>\n        <iframe \n          id="pso-gateway-iframe" \n          src="${this.options.gatewayUrl}" \n          frameborder="0"\n          allow="payment"\n          sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"\n        ></iframe>\n      </div>\n      <div class="pso-footer">\n        <div class="pso-security-info">\n          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">\n            <path d="M8 0L2 3v4c0 3.5 2.5 6.5 6 7 3.5-.5 6-3.5 6-7V3L8 0z"/>\n          </svg>\n          <span>Secured by PSO Payment Gateway</span>\n        </div>\n      </div>\n    `}attachEventListeners(){this.popup.querySelector(".pso-close").addEventListener("click",()=>{this.handleCancel()}),this.iframe&&this.iframe.addEventListener("load",()=>{const e=this.popup.querySelector("#pso-loading");e&&(e.style.display="none")})}setupMessageListener(){this.messageListener=e=>{const t=e.data;this.config.debug,t&&"object"==typeof t&&("PAYMENT_SUCCESS"===t.type||"SUCCESS"===t.status||!0===t.success?this.handleSuccess(t):"PAYMENT_FAILURE"===t.type||"FAILED"===t.status||!1===t.success?this.handleError(t):"PAYMENT_CANCEL"!==t.type&&"CANCELLED"!==t.status||this.handleCancel()),"string"==typeof t&&(t.includes("success")||t.includes("payment-success")?this.handleSuccess({redirectUrl:t}):t.includes("cancel")||t.includes("payment-cancel")?this.handleCancel():(t.includes("failure")||t.includes("payment-failure"))&&this.handleError({redirectUrl:t}))},window.addEventListener("message",this.messageListener),!this.config.usePopupWindow&&this.iframe&&this.monitorIframeRedirects()}monitorIframeRedirects(){try{let e=this.options.gatewayUrl;const t=setInterval(()=>{if(this.iframe&&this.isOpen)try{const o=this.iframe.contentWindow.location.href;o!==e&&(e=o,this.options.successUrl&&o.includes(this.options.successUrl)?(clearInterval(t),this.handleSuccess({redirectUrl:o})):this.options.failureUrl&&o.includes(this.options.failureUrl)?(clearInterval(t),this.handleError({redirectUrl:o})):this.options.cancelUrl&&o.includes(this.options.cancelUrl)&&(clearInterval(t),this.handleCancel()))}catch(e){}else clearInterval(t)},500)}catch(e){}}handleSuccess(e){this.config.debug,this.close(),this.options.onSuccess&&this.options.onSuccess({success:!0,transactionId:this.options.transactionId,sessionId:this.options.sessionId,...e})}handleError(e){this.config.debug,this.close(),this.options.onError&&this.options.onError({success:!1,message:e.message||"Payment failed",transactionId:this.options.transactionId,...e})}handleCancel(){this.config.debug,this.close(),this.options.onCancel&&this.options.onCancel({success:!1,message:"Payment cancelled by user",transactionId:this.options.transactionId})}}class n{constructor(e={}){this.validateConfig(e),this.config={merchantId:e.merchantId,environment:e.environment||"test",gatewayUrl:e.gatewayUrl,theme:e.theme||{},debug:e.debug||!1},this.popup=new o(this.config),this.config.debug}validateConfig(e){if(!e.merchantId)throw new Error("PSOPayment: merchantId is required");if(e.environment&&!["test","production"].includes(e.environment))throw new Error('PSOPayment: environment must be "test" or "production"');"production"===e.environment&&window.location.protocol}async showPaymentForm(e={}){this.validatePaymentOptions(e);const t={orderId:e.orderId||this.generateOrderId(),amount:e.amount,currency:e.currency||"BDT",customerInfo:e.customerInfo||{},productInfo:e.productInfo||{},promotionInfo:e.promotionInfo,discountDetail:e.discountDetail,ipnUrl:e.ipnUrl,successUrl:e.successUrl,cancelUrl:e.cancelUrl,failureUrl:e.failureUrl,customFields:e.customFields||{},onSuccess:e.onSuccess,onError:e.onError,onCancel:e.onCancel,metadata:e.metadata||{}};this.config.debug;try{const e=await this.createPaymentOrder(t);if(!e.success||!e.gatewayPageUrl)throw new Error(e.message||"Failed to create payment order");this.popup.show({gatewayUrl:e.gatewayPageUrl,transactionId:e.transactionId,sessionId:e.sessionId,onSuccess:t.onSuccess,onError:t.onError,onCancel:t.onCancel})}catch(e){throw this.config.debug,t.onError&&t.onError(e),e}}async createPaymentOrder(e){const t="production"===this.config.environment?this.config.gatewayUrl||"https://api.pso-gateway.com":this.config.gatewayUrl||"http://localhost:3000";try{const o={order_id:e.orderId,order_information:{payable_amount:parseFloat(e.amount),currency_code:e.currency},customer_information:e.customerInfo,product_information:e.productInfo,ipn_url:e.ipnUrl,success_url:e.successUrl,cancel_url:e.cancelUrl,failure_url:e.failureUrl};e.promotionInfo&&(o.promotion_information=e.promotionInfo),e.discountDetail&&(o.discount_detail=e.discountDetail),e.customFields&&Object.assign(o,e.customFields);const n=await fetch(`${t}/payment/api/v1/p/service/api/payment/processing/payment-order`,{method:"POST",headers:{"Content-Type":"application/json","X-Merchant-Id":this.config.merchantId},body:JSON.stringify(o)});if(!n.ok){const e=await n.json().catch(()=>({}));throw new Error(e.message||"Failed to create payment order")}const s=await n.json();return this.config.debug,s}catch(e){throw this.config.debug,e}}generateOrderId(){return"ORD-"+Date.now()+"-"+Math.random().toString(36).substr(2,9).toUpperCase()}validatePaymentOptions(e){if(!e.amount||"number"!=typeof e.amount||e.amount<=0)throw new Error("PSOPayment: amount must be a positive number");if(e.currency&&"string"!=typeof e.currency)throw new Error("PSOPayment: currency must be a string")}async verifyPaymentStatus(e){const t="production"===this.config.environment?this.config.gatewayUrl||"https://api.pso-gateway.com":this.config.gatewayUrl||"http://localhost:3000";try{const o=await fetch(`${t}/payment/api/v1/p/service/api/payment/processing/verify`,{method:"POST",headers:{"Content-Type":"application/json","X-Merchant-Id":this.config.merchantId},body:JSON.stringify({paymentOrderId:e})});if(!o.ok)throw new Error("Failed to verify payment");return await o.json()}catch(e){throw this.config.debug,e}}closePaymentForm(){this.popup.close()}static get version(){return"1.0.0"}async createPaymentToken(e){const t="production"===this.config.environment?this.config.gatewayUrl||"https://api.pso-gateway.com":this.config.gatewayUrl||"http://localhost:3000";try{const o=await fetch(`${t}/api/tokens/create`,{method:"POST",headers:{"Content-Type":"application/json","X-Merchant-ID":this.config.merchantId},body:JSON.stringify(e)});if(!o.ok)throw new Error("Failed to create payment token");return await o.json()}catch(e){throw this.config.debug,e}}async verifyPayment(e){const t="production"===this.config.environment?this.config.gatewayUrl||"https://api.pso-gateway.com":this.config.gatewayUrl||"http://localhost:3000";try{const o=await fetch(`${t}/api/payments/verify/${e}`,{method:"GET",headers:{"X-Merchant-ID":this.config.merchantId}});if(!o.ok)throw new Error("Failed to verify payment");return await o.json()}catch(e){throw this.config.debug,e}}}var s=n;"undefined"!=typeof window&&(window.PSOPayment=n);var i=s;return"undefined"!=typeof window&&(window.PSOPayment=s),t.default}()});
//# sourceMappingURL=pso-sdk.min.js.map